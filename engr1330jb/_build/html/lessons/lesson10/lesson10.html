
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>10: Vector/Matrix applications (Under Construction) &#8212; ENGR 1330 Course Notes</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"processClass": "tex2jax_process|mathjax_process|math|output_area"}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="11: Databases" href="../lesson11/lesson11.html" />
    <link rel="prev" title="9: Matrix Manipulation(s) using NumPy" href="../lesson09/lesson09.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/p4e.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">ENGR 1330 Course Notes</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../intro.html">
   Welcome to ENGR 1330
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson00/lesson00.html">
   0: Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson01/lesson01.html">
   1: Data Science and Problem Solving:
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson02/lesson02.html">
   2: Expressions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson03/lesson03.html">
   3: Data Types and Typecasting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson04/lesson04.html">
   4: User Interaction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson041/lesson04.1.html">
   4.1: Data Structures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson05/lesson05.html">
   5: Algorithm Building Blocks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson06/lesson06.html">
   6: Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson07/lesson07.html">
   7: Files
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson08/lesson08.html">
   8: Vectors and Matrices (as lists)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson071/lesson071.html">
   7.1: Files from the Web (
   <code class="docutils literal notranslate">
    <span class="pre">
     requests.get
    </span>
    <span class="pre">
     ...
    </span>
   </code>
   )
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson09/lesson09.html">
   9: Matrix Manipulation(s) using
   <em>
    NumPy
   </em>
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   10: Vector/Matrix applications (Under Construction)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson11/lesson11.html">
   11: Databases
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson12/lesson12.html">
   12: Databases and PANDAS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson13/lesson13.html">
   13: Applications of PANDAS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson14/lesson14.html">
   14: Visual display of data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson15/lesson15.html">
   15: The
   <code class="docutils literal notranslate">
    <span class="pre">
     matplotlib
    </span>
   </code>
   package
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson16/lesson16.html">
   16: Exploratory Data Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson17.html">
   Lesson 17: Matrix manipulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson18.html">
   Lesson 18: Arrays in numpy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson19.html">
   Lesson 19: Database concepts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson20.html">
   Lesson 20: Database processing (
   <code class="docutils literal notranslate">
    <span class="pre">
     pandas
    </span>
   </code>
   )
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson21/lesson21.html">
   21: Testing Hypothesis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson22.html">
   Lesson 22: Plotting (
   <code class="docutils literal notranslate">
    <span class="pre">
     matplotlib
    </span>
   </code>
   )
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson23.html">
   Lesson 23: Data models and visualization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson32/lesson32.html">
   32: K Nearest Neighbor (KNN) Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson33/lesson33.html">
   33: KNN Classification (Continued)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson34/lesson34.html">
   34: KNN Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson35.html">
   Lesson 35: Logistic Regression (Homebrew)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson36.html">
   Lesson 36: Logistic Regression (
   <code class="docutils literal notranslate">
    <span class="pre">
     sklearn
    </span>
   </code>
   )
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson37.html">
   Lesson 37: Nearest Neighbor Classification (Homebrew)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lesson38.html">
   38: K-Nearest Neighbor Classification (sklearn)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../video_log/video_log.html">
   Video Archive
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/lessons/lesson10/lesson10.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/executablebooks/jupyter-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Flessons/lesson10/lesson10.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/lessons/lesson10/lesson10.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#linear-systems-applications">
   Linear Systems Applications
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#curve-fitting">
     Curve-Fitting
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#linear-flow-of-heat">
     Linear Flow of Heat
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#nonlinear-systems-applications">
   Nonlinear Systems Applications
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#newton-raphson-method">
     Newton-Raphson Method
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#example-using-analytical-derivatives">
       Example using Analytical Derivatives
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#quasi-newton-method-using-finite-difference-approximations-for-the-derivative">
       Quasi-Newton Method using Finite Difference Approximations for the Derivative
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercises">
     Exercises
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pipeline-network-simulation">
     Pipeline Network Simulation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#background-pipelines-and-networks">
       Background: Pipelines and Networks
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pipe-networks-topology">
       Pipe Networks – Topology
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#continunity-at-a-node">
       Continunity (at a node)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#energy-loss-along-a-link">
       Energy Loss (along a link)
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#velocity-head">
       Velocity Head
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#added-head-pumps">
       Added Head — Pumps
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#extracted-head-turbines">
       Extracted Head — Turbines
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#pipe-head-loss-models">
       Pipe Head Loss Models
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#laminar-flow-eqn-2-36-pg-17-cite-chin2006">
         Laminar flow (Eqn 2.36, pg. 17~\cite{chin2006}) :
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#hydraulically-smooth-pipes-eqn-2-34-pg-16-cite-chin2006">
         Hydraulically Smooth Pipes(Eqn 2.34 pg. 16~\cite{chin2006}):
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#hydraulically-rough-pipes-eqn-2-34-pg-16-cite-chin2006">
         Hydraulically Rough Pipes(Eqn 2.34 pg. 16~\cite{chin2006}):
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#transitional-pipes-colebrook-white-formula-eqn-2-35-pg-17-cite-chin2006">
         Transitional Pipes (Colebrook-White Formula)(Eqn 2.35 pg. 17~\cite{chin2006}):
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#transitional-pipes-jain-formula-eqn-2-39-pg-19-cite-chin2006">
         Transitional Pipes (Jain Formula)(Eqn 2.39 pg. 19~\cite{chin2006}):
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pipe-networks-solution-methods">
     Pipe Networks Solution Methods
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#network-analysis-example">
     Network Analysis Example
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#script-structure">
       Script Structure
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#support-functions">
       Support Functions
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#augmented-and-jacobian-matrices">
       Augmented and Jacobian Matrices
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#stopping-criteria-and-solution-report">
       Stopping Criteria, and Solution Report}
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-1">
     Exercise 1:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#exercise-2-advanced-optional">
     Exercise 2 (Advanced; optional)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="alert alert-block alert-info">
    <b><h1>ENGR 1330 Computational Thinking with Data Science </h1></b> 
</div> 
<p>Copyright © 2022 Theodore G. Cleveland and Farhang Forghanparast</p>
<p>Last GitHub Commit Date: Never</p>
<div class="tex2jax_ignore mathjax_ignore section" id="vector-matrix-applications-under-construction">
<h1>10: Vector/Matrix applications (Under Construction)<a class="headerlink" href="#vector-matrix-applications-under-construction" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>curve-fitting</p></li>
<li><p>linear heat flow</p></li>
<li><p>network flow (Optional; Non-linear System of equations)</p></li>
</ul>
<div class="section" id="linear-systems-applications">
<h2>Linear Systems Applications<a class="headerlink" href="#linear-systems-applications" title="Permalink to this headline">¶</a></h2>
<div class="section" id="curve-fitting">
<h3>Curve-Fitting<a class="headerlink" href="#curve-fitting" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="linear-flow-of-heat">
<h3>Linear Flow of Heat<a class="headerlink" href="#linear-flow-of-heat" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="nonlinear-systems-applications">
<h2>Nonlinear Systems Applications<a class="headerlink" href="#nonlinear-systems-applications" title="Permalink to this headline">¶</a></h2>
<p>Non-linear systems are extensions of the linear systems cases except the systems involve products and powers of the unknown variables. Non-linear problems are often quite difficult to manage, especially when the systems are large (many rows and many variables).
The solution to non-linear systems, if non-trivial or even possible, are usually iterative. Within the iterative steps is a linearization component – these linear systems which are intermediate computations within the overall solution process are treated by an appropriate linear system method (direct or iterative).
Consider the system below:</p>
<p><span class="math notranslate nohighlight">\(
\begin{gather}
\begin{matrix}
x^2 &amp; +~y^2  \\
 e^x &amp; +~y  \\
\end{matrix}
\begin{matrix}
= 4\\
= 1\\
\end{matrix}
\end{gather}
\)</span></p>
<p>Suppose we have a solution guess <span class="math notranslate nohighlight">\(x_{k},y_{k}\)</span>, which of course could be wrong, but we could linearize about that guess as</p>
<p><span class="math notranslate nohighlight">\(
\begin{gather}
\mathbf{A} =
\begin{pmatrix}
x_k &amp; + ~y_k  \\
0 &amp; + ~1  \\
\end{pmatrix}
~\mathbf{x} = 
\begin{pmatrix}
x_{k+1} \\
y_{k+1} \\
\end{pmatrix}
~ \mathbf{b} = 
\begin{pmatrix}
4\\
1 - e^{x_k}\\
\end{pmatrix}
\end{gather}
\)</span></p>
<p>Now if we assemble the system in the usual fashion, <span class="math notranslate nohighlight">\(\mathbf{A} \cdot \mathbf{x_{k+1}} = ~ \mathbf{b}~\)</span> we have a system of linear equations (Linear in <span class="math notranslate nohighlight">\(\mathbf{x_{k+1}}\)</span>}), which expanded look like:</p>
<p><span class="math notranslate nohighlight">\(
\begin{gather}
\begin{pmatrix}
x_k &amp; + ~y_k  \\
0 &amp; + ~1  \\
\end{pmatrix}
\cdot
\begin{pmatrix}
x_{k+1} \\
y_{k+1} \\
\end{pmatrix}
~ = 
\begin{pmatrix}
4\\
1 - e^{x_k}\\
\end{pmatrix}
\end{gather}
\)</span></p>
<p>Now that the system is linear, and we can solve for <span class="math notranslate nohighlight">\(\mathbf{x_{k+1}}\)</span> using our linear system solver for the new guess.
If the system is convergent (not all are) then if we update, and repeat  we will eventually find a result.</p>
<p>What one really needs is a way to construct the linear system that has a systematic update method, that is discussed below</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The examples below use two user-defined modules listed below.  Use of user-defined modules is discussed in the lesson on functions</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">LinearSolverPivot</span><span class="o">.</span><span class="n">py</span>

<span class="c1"># SolveLinearSystem.py</span>
<span class="c1"># Code to read A and b</span>
<span class="c1"># Then solve Ax = b for x by Gaussian elimination with back substitution</span>
<span class="c1">#</span>
<span class="c1">##########</span>
<span class="k">def</span> <span class="nf">linearsolver</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="c1">#    M = A  #this is object to object equivalence</span>
<span class="c1"># copy A into M element by element</span>
    <span class="n">M</span><span class="o">=</span><span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span><span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">irow</span><span class="p">][</span><span class="n">jcol</span><span class="p">]</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="n">irow</span><span class="p">][</span><span class="n">jcol</span><span class="p">]</span>


    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">M</span><span class="p">:</span>
     <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
     <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
       <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]):</span>
          <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
       <span class="k">else</span><span class="p">:</span>
          <span class="k">pass</span>

     <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
         <span class="n">q</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="o">/</span> <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
         <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">-=</span>  <span class="n">q</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>

    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

    <span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
          <span class="n">z</span> <span class="o">=</span> <span class="n">z</span>  <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
      <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
<span class="c1">#    print (x)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1">#</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="n">vector_matrix_lib</span><span class="o">.</span><span class="n">py</span>

<span class="c1"># vector_matrix_lib.py</span>
<span class="c1"># useful linear algebra tools</span>
<span class="kn">import</span> <span class="nn">math</span>   <span class="c1"># This will import math module</span>

<span class="k">def</span> <span class="nf">writeM</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">ir</span><span class="p">,</span><span class="n">jc</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;------&quot;</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="s2">&quot;------&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">jc</span><span class="p">])</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
    <span class="c1">#return</span>

<span class="k">def</span> <span class="nf">writeV</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">ir</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;------&quot;</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="s2">&quot;------&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
    <span class="c1">#return</span>

<span class="k">def</span> <span class="nf">mmmult</span><span class="p">(</span><span class="n">amatrix</span><span class="p">,</span><span class="n">bmatrix</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">,</span><span class="n">rowNumB</span><span class="p">,</span><span class="n">colNumB</span><span class="p">):</span>
    <span class="n">AB</span> <span class="o">=</span><span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colNumB</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">colNumB</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">colNumA</span><span class="p">):</span>
                <span class="n">AB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">AB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">amatrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">bmatrix</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">AB</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mvmult</span><span class="p">(</span><span class="n">amatrix</span><span class="p">,</span><span class="n">xvector</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">):</span>
    <span class="n">bvector</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">colNumA</span><span class="p">):</span>
                <span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">amatrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">xvector</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">bvector</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">vvadd</span><span class="p">(</span><span class="n">avector</span><span class="p">,</span><span class="n">bvector</span><span class="p">,</span><span class="n">length</span><span class="p">):</span>
    <span class="n">aplusb</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">aplusb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">avector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">aplusb</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">vvsub</span><span class="p">(</span><span class="n">avector</span><span class="p">,</span><span class="n">bvector</span><span class="p">,</span><span class="n">length</span><span class="p">):</span>
    <span class="n">aminusb</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">aminusb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">avector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">aminusb</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">vdotv</span><span class="p">(</span><span class="n">avector</span><span class="p">,</span><span class="n">bvector</span><span class="p">,</span><span class="n">length</span><span class="p">):</span>
    <span class="n">adotb</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">adotb</span><span class="o">=</span><span class="n">adotb</span><span class="o">+</span><span class="n">avector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">adotb</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="newton-raphson-method">
<h3>Newton-Raphson Method<a class="headerlink" href="#newton-raphson-method" title="Permalink to this headline">¶</a></h3>
<p>This section presents the Newton-Raphson method as a way to sometimes solve systems of non-linear equations.</p>
<p>Consider an example where the function <span class="math notranslate nohighlight">\(\textbf{f}\)</span> is a vector-valued function of a vector argument.</p>
<p><span class="math notranslate nohighlight">\(
\begin{gather}
\mathbf{f(x)} = 
\begin{matrix}
f_1 = &amp; x^2 &amp; +~y^2 &amp; - 4\\
f_2 = &amp; e^x &amp; +~y  &amp; - 1\\
\end{matrix}
\end{gather}
\)</span></p>
<p>Let’s also recall Newtons method for scalar valued function of a single variable.</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
x_{k+1}=x_{k} - \frac{  f(x_{k})  }{   \frac{df}{dx}\rvert_{x_k} } 
\label{eqn:NewtonFormula}
\end{equation}
\)</span></p>
<p>When extending to higher dimensions, the analog for <span class="math notranslate nohighlight">\(x\)</span> is the vector <span class="math notranslate nohighlight">\(\textbf{x}\)</span> and the analog for the function <span class="math notranslate nohighlight">\(f()\)</span> is the vector function <span class="math notranslate nohighlight">\(\textbf{f()}\)</span>.
What remains is an analog for the first derivative in the denominator (and the concept of division of a matrix).</p>
<p>The analog to the first derivative is a matrix called the Jacobian which is comprised of the first derivatives of the function <span class="math notranslate nohighlight">\(\textbf{f}\)</span> with respect to the arguments <span class="math notranslate nohighlight">\(\textbf{x}\)</span>.<br />
For example for a 2-value function of 2 arguments (as our example above)</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\frac{df}{dx}\rvert_{x_k} =&gt;
\begin{pmatrix}
\frac{\partial f_1}{\partial x_1} &amp; \frac{\partial f_1}{\partial x_2} \\
~ &amp; ~ \\
\frac{\partial f_2}{\partial x_1} &amp; \frac{\partial f_2}{\partial x_2} \\
\end{pmatrix}
\label{eqn:Jacobian}
\end{equation}
\)</span></p>
<p>Next recall that division is replaced by matrix multiplication with the multiplicative inverse, so the analogy continues as</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\frac{1}{\frac{df}{dx}\rvert_{x_k}} =&gt;
{\begin{pmatrix}
\frac{\partial f_1}{\partial x_1} &amp; \frac{\partial f_1}{\partial x_2} \\
~ &amp; ~ \\
\frac{\partial f_2}{\partial x_1} &amp; \frac{\partial f_2}{\partial x_2} \\
\end{pmatrix}}^{-1}
\label{eqn:JacobianInverse}
\end{equation}
\)</span></p>
<p>Let’s name the Jacobian <span class="math notranslate nohighlight">\(\textbf{J(x)}\)</span>.</p>
<p>So the multi-variate Newton’s method can be written as</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\mathbf{x}_{k+1}=\mathbf{x}_{k} - \mathbf{J(x)}^{-1}\rvert_{x_k} \cdot \mathbf{f(x)}\rvert_{x_k}
\label{eqn:VectorNewtonFormula}
\end{equation}
\)</span></p>
<p>In the linear systems lessons we did find a way to solve for an inverse, but it’s not necessary, and is computationally expensive to invert in these examples – a series of rearrangement of the system above yields a nice scheme that does not require inversion of a matrix.</p>
<p>First, move the <span class="math notranslate nohighlight">\(\mathbf{x}_{k}\)</span> to the left-hand side.</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\mathbf{x}_{k+1}-\mathbf{x}_{k} = - \mathbf{J(x)}^{-1}\rvert_{x_k} \cdot \mathbf{f(x)}\rvert_{x_k}
\end{equation}
\)</span></p>
<p>Next multiply both sides by the Jacobian (The Jacobian must be non-singular otherwise we are dividing by zero)</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\mathbf{J(x)}\rvert_{x_k} \cdot (\mathbf{x}_{k+1}-\mathbf{x}_{k}) = - \mathbf{J(x)}\rvert_{x_k} \cdot \mathbf{J(x)}^{-1}\rvert_{x_k} \cdot \mathbf{f(x)}\rvert_{x_k}
\end{equation}
\)</span></p>
<p>Recall a matrix multiplied by its inverse returns the identity matrix (the matrix equivalent of unity)</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
-\mathbf{J(x)}\rvert_{x_k} \cdot (\mathbf{x}_{k+1}-\mathbf{x}_{k}) = \mathbf{f(x)}\rvert_{x_k}
\end{equation}
\)</span></p>
<p>So we now have an algorithm:</p>
<ol class="simple">
<li><p>Start with an initial guess <span class="math notranslate nohighlight">\(\mathbf{x}_{k}\)</span>, compute <span class="math notranslate nohighlight">\(\mathbf{f(x)}\rvert_{x_k}\)</span>, and <span class="math notranslate nohighlight">\(\mathbf{J(x)}\rvert_{x_k}\)</span>.</p></li>
<li><p>Test for stopping.  Is <span class="math notranslate nohighlight">\(\mathbf{f(x)}\rvert_{x_k}\)</span> close to zero?  If yes, exit and report results, otherwise continue.</p></li>
<li><p>Solve the linear system <span class="math notranslate nohighlight">\(\mathbf{J(x)}\rvert_{x_k} \cdot (\mathbf{x}_{k+1}-\mathbf{x}_{k}) = \mathbf{f(x)}\rvert_{x_k}\)</span>.</p></li>
<li><p>Test for stopping.  Is <span class="math notranslate nohighlight">\( (\mathbf{x}_{k+1}-\mathbf{x}_{k})\)</span> close to zero?  If yes, exit and report results, otherwise continue.</p></li>
<li><p>Compute the update <span class="math notranslate nohighlight">\(\mathbf{x}_{k+1} = \mathbf{x}_{k} - (\mathbf{x}_{k+1}-\mathbf{x}_{k}) \)</span>, then</p></li>
<li><p>Move the update into the guess vector <span class="math notranslate nohighlight">\(\mathbf{x}_{k} &lt;=\mathbf{x}_{k+1}\)</span> =and repeat step 1. Stop after too many steps.</p></li>
</ol>
<div class="section" id="example-using-analytical-derivatives">
<h4>Example using Analytical Derivatives<a class="headerlink" href="#example-using-analytical-derivatives" title="Permalink to this headline">¶</a></h4>
<p>Now to complete the example we will employ this algorithm.</p>
<p>The function (repeated)</p>
<p><span class="math notranslate nohighlight">\(
\begin{gather}
\mathbf{f(x)} = 
\begin{matrix}
f_1 = &amp; x^2 &amp; +~y^2 &amp; - 4\\
f_2 = &amp; e^x &amp; +~y  &amp; - 1\\
\end{matrix}
\end{gather}
\)</span></p>
<p>Then the Jacobian, here we will compute it analytically because we can</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\mathbf{J(x)}=&gt;
{\begin{pmatrix}
2x &amp; 2y \\
~ &amp; ~ \\
e^x &amp; 1 \\
\end{pmatrix}}
\end{equation}
\)</span></p>
<p>Now for the scripts.</p>
<p>We will start by defining the two equations, and their derivatives, as well a a vector valued function <code class="docutils literal notranslate"><span class="pre">func</span></code> and its Jacobian <code class="docutils literal notranslate"><span class="pre">jacob</span></code> as below.  Here the two modules <code class="docutils literal notranslate"><span class="pre">LinearSolverPivot</span></code> and <code class="docutils literal notranslate"><span class="pre">vector_matrix_lib</span></code> are just python source code files containing prototype functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#################################################################</span>
<span class="c1"># Newton Solver Example -- Analytical Derivatives               #</span>
<span class="c1">#################################################################</span>
<span class="kn">import</span> <span class="nn">math</span>   <span class="c1"># This will import math module from python distribution</span>
<span class="kn">from</span> <span class="nn">LinearSolverPivot</span> <span class="kn">import</span> <span class="n">linearsolver</span> <span class="c1"># This will import our solver module</span>
<span class="kn">from</span> <span class="nn">vector_matrix_lib</span> <span class="kn">import</span> <span class="n">writeM</span><span class="p">,</span><span class="n">writeV</span><span class="p">,</span><span class="n">vdotv</span><span class="p">,</span><span class="n">vvsub</span> <span class="c1"># This will import our vector functions</span>

<span class="k">def</span> <span class="nf">eq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">eq1</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">4.0</span>
    <span class="k">return</span><span class="p">(</span><span class="n">eq1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">eq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">eq2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="k">return</span><span class="p">(</span><span class="n">eq2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ddxeq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">ddxeq1</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">x</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ddxeq1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ddyeq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">ddyeq1</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">y</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ddyeq1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ddxeq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">ddxeq2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ddxeq2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ddyeq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">ddyeq2</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ddyeq2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">func</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># null list</span>
    <span class="c1"># build the function</span>
    <span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">func</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">jacob</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">jacob</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># constructed list  </span>
    <span class="c1">#build the  jacobian</span>
    <span class="n">jacob</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">ddxeq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">jacob</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">ddyeq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">jacob</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">ddxeq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">jacob</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">ddyeq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">jacob</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next we create vectors to store values, and supply initial guesses to the system, and echo the inputs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">deltax</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># null list</span>
<span class="n">xguess</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># null list</span>
<span class="n">myfunc</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># null list</span>
<span class="n">myjacob</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># constructed list  </span>
<span class="c1"># supply initial guess</span>
<span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span> <span class="p">;</span> <span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
<span class="c1">#xguess[0] = float(input(&quot;Value for x : &quot;))</span>
<span class="c1">#xguess[1] = float(input(&quot;Value for y : &quot;))</span>
<span class="c1"># build the initial function</span>
<span class="n">myfunc</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#build the initial jacobian</span>
<span class="n">myjacob</span><span class="o">=</span><span class="n">jacob</span><span class="p">(</span><span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#write initial results</span>
<span class="n">writeV</span><span class="p">(</span><span class="n">xguess</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Initial X vector &quot;</span><span class="p">)</span>
<span class="n">writeV</span><span class="p">(</span><span class="n">myfunc</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Initial FUNC vector &quot;</span><span class="p">)</span>
<span class="n">writeM</span><span class="p">(</span><span class="n">myjacob</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Initial Jacobian &quot;</span><span class="p">)</span>
<span class="c1"># solver parameters</span>
<span class="n">tolerancef</span> <span class="o">=</span> <span class="mf">1.0e-9</span>
<span class="n">tolerancex</span> <span class="o">=</span> <span class="mf">1.0e-9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>------ Initial X vector  ------
1.0
0.0
-----------------------------
------ Initial FUNC vector  ------
-3.0
1.718281828459045
-----------------------------
------ Initial Jacobian  ------
[2.0, 0.0]
[2.718281828459045, 1.0]
-----------------------------
</pre></div>
</div>
</div>
</div>
<p>Now we apply the algorithm a few times, here the count is set to 10. So eneter the loop, test for stopping, then update.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Newton-Raphson</span>
<span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">myfunc</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">testf</span> <span class="o">=</span> <span class="n">vdotv</span><span class="p">(</span><span class="n">myfunc</span><span class="p">,</span><span class="n">myfunc</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">testf</span> <span class="o">&lt;=</span> <span class="n">tolerancef</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f(x) close to zero</span><span class="se">\n</span><span class="s2"> test value : &quot;</span><span class="p">,</span> <span class="n">testf</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="n">myjacob</span><span class="o">=</span><span class="n">jacob</span><span class="p">(</span><span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">deltax</span><span class="o">=</span><span class="n">linearsolver</span><span class="p">(</span><span class="n">myjacob</span><span class="p">,</span><span class="n">myfunc</span><span class="p">)</span>
    <span class="n">testx</span> <span class="o">=</span> <span class="n">vdotv</span><span class="p">(</span><span class="n">deltax</span><span class="p">,</span><span class="n">deltax</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">testx</span> <span class="o">&lt;=</span> <span class="n">tolerancex</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solution change small</span><span class="se">\n</span><span class="s2"> test value : &quot;</span><span class="p">,</span> <span class="n">testx</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="n">xguess</span><span class="o">=</span><span class="n">vvsub</span><span class="p">(</span><span class="n">xguess</span><span class="p">,</span><span class="n">deltax</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">##    print(&quot;iteration : &quot;,iteration)</span>
<span class="c1">##    writeV(xguess,2,&quot;Current X vector &quot;)</span>
<span class="c1">##    writeV(myfunc,2,&quot;Current FUNC vector &quot;)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exiting Iteration : &quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
<span class="n">writeV</span><span class="p">(</span><span class="n">xguess</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Exiting X vector &quot;</span><span class="p">)</span>
<span class="n">writeV</span><span class="p">(</span><span class="n">myfunc</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Exiting FUNC vector &quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f(x) close to zero
 test value :  1.3156082836179522e-12
Exiting Iteration :  6
------ Exiting X vector  ------
1.0041690772134464
-1.7296372862705844
-----------------------------
------ Exiting FUNC vector  ------
6.776891758875081e-07
9.253894663885376e-07
-----------------------------
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="quasi-newton-method-using-finite-difference-approximations-for-the-derivative">
<h4>Quasi-Newton Method using Finite Difference Approximations for the Derivative<a class="headerlink" href="#quasi-newton-method-using-finite-difference-approximations-for-the-derivative" title="Permalink to this headline">¶</a></h4>
<p>The next variant is to approximate the derivatives – usually a Finite-Difference approximation is used, either forward, backward, or centered differences – generally determined based on the actual behavior of the functions themselves or by trial and error.</p>
<p>For really huge systems, we usually make the program itself make the adaptions as it proceeds.</p>
<p>The coding for a finite-difference representation of a Jacobian is shown in Listing that follows
In constructing the Jacobian, we observe that each column of the Jacobian is simply the directional derivative of the function with respect to the variable associated with the column.<br />
For instance, the first column of the Jacobian in the example is first derivative of the first function (all rows) with respect to the first variable, in this case <span class="math notranslate nohighlight">\(x\)</span>.  The second column is the first derivative of the second function with respect to the second variable, <span class="math notranslate nohighlight">\(y\)</span>.<br />
This structure is useful to generalize the Jacobian construction method because we could write (yet another) prototype function that can take the directional derivatives for us, and just insert the returns as columns; in the example we simply modified the <code class="docutils literal notranslate"><span class="pre">ddx</span></code> and <code class="docutils literal notranslate"><span class="pre">ddy</span></code> functions from analytical to simple finite differences.</p>
<p>The example listing is specific to the 2X2 function in the example, but the extension to more general cases is evident.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#################################################################</span>
<span class="c1"># Newton Solver Example -- Numerical Derivatives               #</span>
<span class="c1">#################################################################</span>
<span class="kn">import</span> <span class="nn">math</span>   <span class="c1"># This will import math module from python distribution</span>
<span class="kn">from</span> <span class="nn">LinearSolverPivot</span> <span class="kn">import</span> <span class="n">linearsolver</span> <span class="c1"># This will import our solver module</span>
<span class="kn">from</span> <span class="nn">vector_matrix_lib</span> <span class="kn">import</span> <span class="n">writeM</span><span class="p">,</span><span class="n">writeV</span><span class="p">,</span><span class="n">vdotv</span><span class="p">,</span><span class="n">vvsub</span> <span class="c1"># This will import our vector functions</span>

<span class="k">def</span> <span class="nf">eq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">eq1</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">4.0</span>
    <span class="k">return</span><span class="p">(</span><span class="n">eq1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">eq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">eq2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="k">return</span><span class="p">(</span><span class="n">eq2</span><span class="p">)</span>
<span class="c1">##############################################################</span>
<span class="c1"># This portion is changed for finite-difference method to evaluate derivatives #</span>
<span class="c1">##############################################################</span>
<span class="k">def</span> <span class="nf">ddxeq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
    <span class="n">ddxeq1</span> <span class="o">=</span> <span class="p">(</span><span class="n">eq1</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">delta</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">eq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="n">delta</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ddxeq1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ddyeq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
    <span class="n">ddyeq1</span> <span class="o">=</span> <span class="p">(</span><span class="n">eq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span><span class="o">-</span><span class="n">eq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="n">delta</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ddyeq1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ddxeq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
    <span class="n">ddxeq2</span> <span class="o">=</span> <span class="p">(</span><span class="n">eq2</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">delta</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="n">eq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="n">delta</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ddxeq2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ddyeq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
    <span class="n">ddyeq2</span> <span class="o">=</span> <span class="p">(</span><span class="n">eq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span><span class="o">-</span><span class="n">eq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="n">delta</span>
    <span class="k">return</span><span class="p">(</span><span class="n">ddyeq2</span><span class="p">)</span>
<span class="c1">##############################################################</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">func</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># null list</span>
    <span class="c1"># build the function</span>
    <span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">func</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">jacob</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">jacob</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># constructed list  </span>
    <span class="c1">#build the  jacobian</span>
    <span class="n">jacob</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">ddxeq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">jacob</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">ddyeq1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">jacob</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">ddxeq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">jacob</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">ddyeq2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">jacob</span><span class="p">)</span>
<span class="n">deltax</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># null list</span>
<span class="n">xguess</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># null list</span>
<span class="n">myfunc</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># null list</span>
<span class="n">myjacob</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="c1"># constructed list  </span>
<span class="c1"># supply initial guess</span>
<span class="c1"># xguess[0] = float(input(&quot;Value for x : &quot;))</span>
<span class="c1"># xguess[1] = float(input(&quot;Value for y : &quot;))</span>
<span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span> <span class="p">;</span> <span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
<span class="c1"># build the initial function</span>
<span class="n">myfunc</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#build the initial jacobian</span>
<span class="n">myjacob</span><span class="o">=</span><span class="n">jacob</span><span class="p">(</span><span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#write initial results</span>
<span class="n">writeV</span><span class="p">(</span><span class="n">xguess</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Initial X vector &quot;</span><span class="p">)</span>
<span class="n">writeV</span><span class="p">(</span><span class="n">myfunc</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Initial FUNC vector &quot;</span><span class="p">)</span>
<span class="n">writeM</span><span class="p">(</span><span class="n">myjacob</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Initial Jacobian &quot;</span><span class="p">)</span>
<span class="c1"># solver parameters</span>
<span class="n">tolerancef</span> <span class="o">=</span> <span class="mf">1.0e-9</span>
<span class="n">tolerancex</span> <span class="o">=</span> <span class="mf">1.0e-9</span>
<span class="c1"># Newton-Raphson</span>
<span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">myfunc</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">testf</span> <span class="o">=</span> <span class="n">vdotv</span><span class="p">(</span><span class="n">myfunc</span><span class="p">,</span><span class="n">myfunc</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">testf</span> <span class="o">&lt;=</span> <span class="n">tolerancef</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f(x) close to zero</span><span class="se">\n</span><span class="s2"> test value : &quot;</span><span class="p">,</span> <span class="n">testf</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="n">myjacob</span><span class="o">=</span><span class="n">jacob</span><span class="p">(</span><span class="n">xguess</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xguess</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">deltax</span><span class="o">=</span><span class="n">linearsolver</span><span class="p">(</span><span class="n">myjacob</span><span class="p">,</span><span class="n">myfunc</span><span class="p">)</span>
    <span class="n">testx</span> <span class="o">=</span> <span class="n">vdotv</span><span class="p">(</span><span class="n">deltax</span><span class="p">,</span><span class="n">deltax</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">testx</span> <span class="o">&lt;=</span> <span class="n">tolerancex</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solution change small</span><span class="se">\n</span><span class="s2"> test value : &quot;</span><span class="p">,</span> <span class="n">testx</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="n">xguess</span><span class="o">=</span><span class="n">vvsub</span><span class="p">(</span><span class="n">xguess</span><span class="p">,</span><span class="n">deltax</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="c1">##    print(&quot;iteration : &quot;,iteration)</span>
<span class="c1">##    writeV(xguess,2,&quot;Current X vector &quot;)</span>
<span class="c1">##    writeV(myfunc,2,&quot;Current FUNC vector &quot;)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exiting Iteration : &quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
<span class="n">writeV</span><span class="p">(</span><span class="n">xguess</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Exiting X vector &quot;</span><span class="p">)</span>
<span class="n">writeV</span><span class="p">(</span><span class="n">myfunc</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="s2">&quot;Exiting FUNC vector using Finite-Differences&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>------ Initial X vector  ------
1.0
0.0
-----------------------------
------ Initial FUNC vector  ------
-3.0
1.718281828459045
-----------------------------
------ Initial Jacobian  ------
[2.0000009999243673, 1.000088900582341e-06]
[2.7182831874306146, 1.000000000139778]
-----------------------------
f(x) close to zero
 test value :  1.319054848649505e-12
Exiting Iteration :  6
------ Exiting X vector  ------
1.0041690776563807
-1.7296372862709128
-----------------------------
------ Exiting FUNC vector using Finite-Differences ------
6.785798740693849e-07
9.265981886219521e-07
-----------------------------
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="exercises">
<h3>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h3>
<p>Write a script that forward defines the multi-variate functions and implements the Newton-Raphson technique.
Implement the method, using analytical derivatives, and find a solution to:</p>
<p><span class="math notranslate nohighlight">\(
\begin{gather}
\begin{matrix}
 x^3 &amp; +~3y^2 &amp; = 21\\
x^2&amp; +~2y  &amp; = -2 \\
\end{matrix}
\end{gather}
\)</span></p>
<p>Repeat the exercise, except use finite-differences to approximate the derivatives.</p>
<p>Write a script that forward defines the multi-variate functions and implements the Newton-Raphson technique.
Implement the method, using analytical derivatives, and find a solution to:</p>
<p><span class="math notranslate nohighlight">\(
\begin{gather}
\begin{matrix}
x^2 &amp; +~ y^2 &amp; +~z^2 &amp; =~ 9\\
~ &amp; ~ &amp; xyz &amp; =~ 1\\
x &amp; +~ y &amp; -z^2 &amp; =~ 0\\
\end{matrix}
\end{gather}
\)</span></p>
<p>Repeat the exercise, except use finite-differences to approximate the derivatives.</p>
<p>Write a script that forward defines the multi-variate functions and implements the Newton-Raphson technique.
Implement the method, using analytical derivatives, and find a solution to:</p>
<p><span class="math notranslate nohighlight">\(
\begin{gather}
\begin{matrix}
xyz &amp; -~ x^2 &amp; +~y^2 &amp; =~ 1.34\\
~ &amp; xy &amp;-~z^2 &amp; =~ 0.09\\
e^x &amp; -~ e^y &amp; +z &amp; =~ 0.41\\
\end{matrix}
\end{gather}
\)</span></p>
<p>Repeat the exercise, except use finite-differences to approximate the derivatives.</p>
</div>
<div class="section" id="pipeline-network-simulation">
<h3>Pipeline Network Simulation<a class="headerlink" href="#pipeline-network-simulation" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The network simulator uses input files to convey the network to the program These files are listed below.</p>
</div>
<blockquote>
<div><p>PipeNetwork.txt</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">4</span>
<span class="mi">6</span>
<span class="mi">200</span> <span class="mi">200</span> <span class="mi">200</span> <span class="mi">200</span> <span class="mi">200</span>
<span class="mf">1.00</span> <span class="mf">0.67</span> <span class="mf">0.67</span> <span class="mf">0.67</span> <span class="mf">0.67</span> <span class="mf">0.5</span>
<span class="mi">800</span> <span class="mi">800</span> <span class="mi">700</span> <span class="mi">700</span> <span class="mi">800</span> <span class="mi">600</span>
<span class="mf">0.00001</span> <span class="mf">0.00001</span> <span class="mf">0.00001</span> <span class="mf">0.00001</span> <span class="mf">0.00001</span> <span class="mf">0.00001</span>
<span class="mf">0.000011</span>
<span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="mi">1</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span><span class="mi">1</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="mi">4</span> <span class="mi">3</span> <span class="mi">1</span> <span class="o">-</span><span class="mi">100</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> 

</pre></div>
</div>
<div class="section" id="background-pipelines-and-networks">
<h4>Background: Pipelines and Networks<a class="headerlink" href="#background-pipelines-and-networks" title="Permalink to this headline">¶</a></h4>
<p>Pipe networks are analyzed for head losses in order to size pumps, determine demand management strategies, and precict minimum pressures in the system.</p>
</div>
<div class="section" id="pipe-networks-topology">
<h4>Pipe Networks – Topology<a class="headerlink" href="#pipe-networks-topology" title="Permalink to this headline">¶</a></h4>
<p>Network topology refers to the layout and connections.<br />
Networks are built of nodes (junctions) and arcs (links).</p>
</div>
<div class="section" id="continunity-at-a-node">
<h4>Continunity (at a node)<a class="headerlink" href="#continunity-at-a-node" title="Permalink to this headline">¶</a></h4>
<p>Water is considered incompressible in steady flow in pipelines and pipe networks, and the
conservation of mass reduces to the volumetric flow rate, <span class="math notranslate nohighlight">\(Q\)</span>,</p>
<p><span class="math notranslate nohighlight">\(Q = AV\)</span></p>
<p>where <span class="math notranslate nohighlight">\(A\)</span> is the cross sectional of the pipe, and <span class="math notranslate nohighlight">\(V\)</span> is the mean section velocity. Typical units
for discharge is liters per second (lps), gallons per minute (gpm), cubic meters per second
(cms), cubic feet per second (cfs), and million gallons per day (mgd).</p>
<p>The continuity equation in two cross-sections of a pipe as depicted in <a class="reference internal" href="#continuity-across-sections"><span class="std std-numref">Fig. 8</span></a> is</p>
<p><span class="math notranslate nohighlight">\( A_1V_1 = A_2V_2 \)</span></p>
<p>Junctions (nodes) are where two or more pipes join together.
A three-pipe junction node with constant external demand is shown in <a class="reference internal" href="#continuity-at-node"><span class="std std-numref">Fig. 9</span></a>.</p>
<p>The continuity equation for the
junction node is
\begin{equation}
Q_1 - Q_2 - Q_3 - D = 0
\end{equation}</p>
<div class="figure align-default" id="continuity-across-sections">
<a class="reference internal image-reference" href="../../_images/continuity-across-sections.png"><img alt="../../_images/continuity-across-sections.png" src="../../_images/continuity-across-sections.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 8 </span><span class="caption-text">Continuity of mass (discharge) across a change in cross section</span><a class="headerlink" href="#continuity-across-sections" title="Permalink to this image">¶</a></p>
</div>
<div class="figure align-default" id="continuity-at-node">
<a class="reference internal image-reference" href="../../_images/continuity-at-node.png"><img alt="../../_images/continuity-at-node.png" src="../../_images/continuity-at-node.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 9 </span><span class="caption-text">Continuity of mass (discharge) across a node (junction)</span><a class="headerlink" href="#continuity-at-node" title="Permalink to this image">¶</a></p>
</div>
<p>In pipe network analysis, all demands on the system are stipulated to belocated at junctions (nodes), and the flow connecting junctions is assumed to be uniform across the cross sections (so that mean velocities apply).  If a substantial demand is located between nodes, then an additional node is established at the demand location.</p>
</div>
<div class="section" id="energy-loss-along-a-link">
<h4>Energy Loss (along a link)<a class="headerlink" href="#energy-loss-along-a-link" title="Permalink to this headline">¶</a></h4>
<p>The equation below is the one-dimensional steady flow form of the energy equation typically applied for pressurized conduit hydraulics.</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\frac{p_1}{\rho g}+\alpha_1 \frac{V_1^2}{2g} + z_1 + h_p =
\frac{p_2}{\rho g}+\alpha_2 \frac{V_2^2}{2g} + z_2 + h_t + h_l
\label{eqn:closed-conduit-energy-equation}
\end{equation}
\)</span></p>
<p>where <span class="math notranslate nohighlight">\(\frac{p}{\rho g}\)</span> is the pressure head at a location, <span class="math notranslate nohighlight">\(\alpha \frac{V^2}{2g}\)</span> is the velocity head at a location, <span class="math notranslate nohighlight">\(z\)</span> is the elevation, <span class="math notranslate nohighlight">\(h_p\)</span> is the added head from a pump, <span class="math notranslate nohighlight">\(h_t\)</span> is the added head extracted by a turbine, and <span class="math notranslate nohighlight">\(h_l\)</span> is the head loss between sections 1 and 2.   <a class="reference internal" href="#closed-conduit-energy"><span class="std std-numref">Fig. 10</span></a> is a sketch that illustrates the various components in the energy equation.</p>
<div class="figure align-default" id="closed-conduit-energy">
<a class="reference internal image-reference" href="../../_images/closed-conduit-energy.png"><img alt="../../_images/closed-conduit-energy.png" src="../../_images/closed-conduit-energy.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 10 </span><span class="caption-text">Definition sketch for energy equation</span><a class="headerlink" href="#closed-conduit-energy" title="Permalink to this image">¶</a></p>
</div>
<p>In network analysis this energy equation is applied to a link that joins two nodes.
Pumps and turbines would be treated as separate components (links) and their hydraulic behavior must be supplied using their respective pump/turbine curves.</p>
</div>
<div class="section" id="velocity-head">
<h4>Velocity Head<a class="headerlink" href="#velocity-head" title="Permalink to this headline">¶</a></h4>
<p>The velocity in <span class="math notranslate nohighlight">\(\alpha \frac{V^2}{2g}\)</span> is the mean section velocity and is the ratio of discharge to flow area.  The kinetic energy correction coefficient is
<span class="math notranslate nohighlight">\(\begin{equation}
\alpha=\frac{\int_A u^3 dA}{V^3 A}
\label{eqn:kinetic-energy-correction}
\end{equation}
\)</span>
where <span class="math notranslate nohighlight">\(u\)</span> is the point velocity in the cross section (usually measured relative to the centerline or the pipe wall; axial symmetry is assumed).   Generally values of <span class="math notranslate nohighlight">\(\alpha\)</span> are 2.0 if the flow is laminar, and approach unity (1.0) for turbulent flow.  In most water distribution systems the flow is usually turbulent so <span class="math notranslate nohighlight">\(\alpha\)</span> is assumed to be unity and the velocity head is simply <span class="math notranslate nohighlight">\(\frac{V^2}{2g}\)</span>.</p>
</div>
<div class="section" id="added-head-pumps">
<h4>Added Head — Pumps<a class="headerlink" href="#added-head-pumps" title="Permalink to this headline">¶</a></h4>
<p>The head supplied by a pump is related to the mechanical power supplied to the flow.   Equation \ref{eqn:pump-power} is the relationship of mechanical power to added pump head.
<span class="math notranslate nohighlight">\(
\begin{equation}
\eta P=Q\rho g h_p
\label{eqn:pump-power}
\end{equation}
\)</span>
where the power supplied to the motor is <span class="math notranslate nohighlight">\(P\)</span> and the  “wire-to-water” efficiency is <span class="math notranslate nohighlight">\(\eta\)</span>.</p>
<p>If the relationship is re-written in terms of added head(A negative head loss!} the pump curve is
<span class="math notranslate nohighlight">\(
\begin{equation}
h_p = \frac{\eta P}{Q\rho g}
\label{eqn:pump-curve}
\end{equation}
\)</span></p>
<p>This relationship illustrates that as discharge increases (for a fixed power) the added head decreases.
Power scales at about the cube of discharge, so pump curves for computational application typically have a mathematical structure like
<span class="math notranslate nohighlight">\(
\begin{equation}
h_p =  H_{\text{shutoff}} - K_{\text{pump}}Q^{\text{exponent}}
\label{eqn:pump-curve-2}
\end{equation}
\)</span></p>
</div>
<div class="section" id="extracted-head-turbines">
<h4>Extracted Head — Turbines<a class="headerlink" href="#extracted-head-turbines" title="Permalink to this headline">¶</a></h4>
<p>The head recovered by a turbine is also an “added head” but appears on the loss side of the equation.<br />
The power that can be recovered by a turbine (again using the concept of “water-to-wire” efficiency is
<span class="math notranslate nohighlight">\(
\begin{equation}
P=\eta Q\rho g h_t
\label{eqn:turbine-power}
\end{equation}
\)</span></p>
</div>
<div class="section" id="pipe-head-loss-models">
<h4>Pipe Head Loss Models<a class="headerlink" href="#pipe-head-loss-models" title="Permalink to this headline">¶</a></h4>
<p>The Darcy-Weisbach, Chezy-Manning, and Hazen-Williams formulas are relationships between physical pipe characteristics, flow parameters, and head loss.   The Darcy-Weisbach formula is the most consistent with the energy equation formulation being derivable (in structural form) from elementary principles (continunity and linear momentum), whereas the other two are empirical (despite the empirical nature of these two models all three are of practical use, and given a choice select your favorite!)</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
h_{L_f}=f \frac{L}{D} \frac{V^2}{2g}
\label{eqn:dw-headloss}
\end{equation}
\)</span></p>
<p>where <span class="math notranslate nohighlight">\(h_{L_f}\)</span> is the head loss from pipe friction, <span class="math notranslate nohighlight">\(f\)</span> is a dimensionless friction factor, <span class="math notranslate nohighlight">\(L\)</span> is the pipe length, <span class="math notranslate nohighlight">\(D\)</span> is the pipe characteristic diameter, <span class="math notranslate nohighlight">\(V\)</span> is the mean section velocity, and <span class="math notranslate nohighlight">\(g\)</span> is the gravitational acceleration.</p>
<p>The friction factor, <span class="math notranslate nohighlight">\(f\)</span>, is a function of Reynolds number <span class="math notranslate nohighlight">\(Re_D\)</span> and the roughness ratio <span class="math notranslate nohighlight">\(\frac{k_s}{D}\)</span>.
<span class="math notranslate nohighlight">\(
\begin{equation}
f=\sigma(Re_D,\frac{k_s}{D})
\label{eqn:friction-factor-dimensionless}
\end{equation}
\)</span></p>
<p>The structure of <span class="math notranslate nohighlight">\(\sigma\)</span> is determined experimentally.  Over the last century the structure is generally accepted to be one of the following depending on flow conditions and pipe properties</p>
<div class="section" id="laminar-flow-eqn-2-36-pg-17-cite-chin2006">
<h5>Laminar flow (Eqn 2.36, pg. 17~\cite{chin2006}) :<a class="headerlink" href="#laminar-flow-eqn-2-36-pg-17-cite-chin2006" title="Permalink to this headline">¶</a></h5>
<p><span class="math notranslate nohighlight">\(\begin{equation}
f=\frac{64}{Re_D}
\label{eqn:friction-factor-laminar}
\end{equation}
\)</span></p>
</div>
<div class="section" id="hydraulically-smooth-pipes-eqn-2-34-pg-16-cite-chin2006">
<h5>Hydraulically Smooth Pipes(Eqn 2.34 pg. 16~\cite{chin2006}):<a class="headerlink" href="#hydraulically-smooth-pipes-eqn-2-34-pg-16-cite-chin2006" title="Permalink to this headline">¶</a></h5>
<p><span class="math notranslate nohighlight">\(\begin{equation}
\frac{1}{\sqrt{f}}=-2 log_{10} (\frac{2.51}{Re_d \sqrt{f} })
\label{eqn:friction-factor-smooth}
\end{equation}
\)</span></p>
</div>
<div class="section" id="hydraulically-rough-pipes-eqn-2-34-pg-16-cite-chin2006">
<h5>Hydraulically Rough Pipes(Eqn 2.34 pg. 16~\cite{chin2006}):<a class="headerlink" href="#hydraulically-rough-pipes-eqn-2-34-pg-16-cite-chin2006" title="Permalink to this headline">¶</a></h5>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\frac{1}{\sqrt{f}}=-2 log_{10} (\frac{\frac{k_e}{D}} {3.7})
\label{eqn:friction-factor-rough}
\end{equation}
\)</span></p>
</div>
<div class="section" id="transitional-pipes-colebrook-white-formula-eqn-2-35-pg-17-cite-chin2006">
<h5>Transitional Pipes (Colebrook-White Formula)(Eqn 2.35 pg. 17~\cite{chin2006}):<a class="headerlink" href="#transitional-pipes-colebrook-white-formula-eqn-2-35-pg-17-cite-chin2006" title="Permalink to this headline">¶</a></h5>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\frac{1}{\sqrt{f}}=-2 log_{10} (\frac{\frac{k_e}{D}} {3.7} + \frac{2.51}{Re_d \sqrt{f} } )
\label{eqn:friction-factor-CW}
\end{equation}
\)</span></p>
</div>
<div class="section" id="transitional-pipes-jain-formula-eqn-2-39-pg-19-cite-chin2006">
<h5>Transitional Pipes (Jain Formula)(Eqn 2.39 pg. 19~\cite{chin2006}):<a class="headerlink" href="#transitional-pipes-jain-formula-eqn-2-39-pg-19-cite-chin2006" title="Permalink to this headline">¶</a></h5>
<p><span class="math notranslate nohighlight">\(\begin{equation}
f=\frac{0.25}{[log_{10} (\frac{\frac{k_e}{D}} {3.7} + \frac{5.74}{Re_d^{0.9} } )]  ^2}
\label{eqn:friction-factor-Jain}
\end{equation}
\)</span></p>
</div>
</div>
</div>
<div class="section" id="pipe-networks-solution-methods">
<h3>Pipe Networks Solution Methods<a class="headerlink" href="#pipe-networks-solution-methods" title="Permalink to this headline">¶</a></h3>
<p>Several methods are used to produce solutions (estimates of discharge, head loss, and pressure) in a network.<br />
An early one, that only involves analysis of loops is the Hardy-Cross method.<br />
A later one, more efficient, is a Newton-Raphson method that uses node equations to balance discharges and demands, and loop equations to balance head losses.</p>
<p>However, a rather ingenious method exists developed by \cite{Haman1971}, where the flow distribution and head values are determined simultaneously.   The task here is to  outline the \cite{Haman1971} method on the problem below – first some necessary definitions and analysis.</p>
<p>The fundamental procedure is:</p>
<ul class="simple">
<li><p>Continuity is written at nodes (node equations).</p></li>
<li><p>Energy loss (gain) is written along links (pipe equations).</p></li>
<li><p>The entire set of equations is solved simultaneously.</p></li>
</ul>
</div>
<div class="section" id="network-analysis-example">
<h3>Network Analysis Example<a class="headerlink" href="#network-analysis-example" title="Permalink to this headline">¶</a></h3>
<div class="figure align-default" id="pipe-net-hybrid">
<a class="reference internal image-reference" href="../../_images/pipe-net-hybrid.png"><img alt="../../_images/pipe-net-hybrid.png" src="../../_images/pipe-net-hybrid.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 11 </span><span class="caption-text">Pipe network for illustrative example with supply and demands identified.  Pipe dimensions and diameters are also depicted.</span><a class="headerlink" href="#pipe-net-hybrid" title="Permalink to this image">¶</a></p>
</div>
<p><a class="reference internal" href="#pipe-net-hybrid"><span class="std std-numref">Fig. 11</span></a> is a sketch of the problem that will be used.<br />
The network supply is the fixed-grade node in the upper left hand corner of the drawing.<br />
The remaining nodes (N1 – N4) have demands specified as the purple outflow arrows.
The pipes are labeled (P1 – P6), and the red arrows indicate a positive flow direction, that is, if the flow is in the indicated direction, the numerical value of flow (or velocity) in that link would be a positive number.</p>
<p>Define the flows in each pipe and the total head at each node as <span class="math notranslate nohighlight">\(Q_i\)</span> and <span class="math notranslate nohighlight">\(H_i\)</span> where the subscript indicates the particular component identification.  Expressed as a vector, these unknowns are:</p>
<p><span class="math notranslate nohighlight">\(
\begin{matrix}
[Q_1, &amp; Q_2, &amp; Q_3,  &amp; Q_4, &amp; Q_5, &amp; Q_6, &amp; H_1, &amp; H_2, &amp; H_3, &amp;H_4 ]&amp; =  &amp; \textbf{x} \\
\end{matrix}
\)</span></p>
<p>If we analyze continuity for each node we will have 4 equations (corresponding to each node) for continunity, for instance for Node N2 the equation is</p>
<p><span class="math notranslate nohighlight">\(
\begin{matrix}
~&amp; Q_2 &amp; -Q_3  &amp; ~ &amp; ~ &amp; Q_6 &amp; ~ &amp; ~ &amp; ~ &amp;~ &amp; =  &amp; 4\\
\end{matrix}
\)</span></p>
<p>Similarily if we define head loss in any pipe as <span class="math notranslate nohighlight">\(\Delta H_i = f \frac{8 L_i}{\pi^2 g D_i^5} |Q_i| Q_i\)</span> or <span class="math notranslate nohighlight">\(\Delta H_i = L_i Q_i\)</span>, where <span class="math notranslate nohighlight">\(L_i = f \frac{8 L_i}{\pi^2 g D_i^5} |Q_i|\)</span>, then we have 6 equations (corresponding to each pipe) for energy, for instance for Pipe (P2) the equation is:</p>
<p><span class="math notranslate nohighlight">\(
\begin{matrix}
~&amp; -L_2Q_2&amp; ~ &amp; ~ &amp; ~ &amp; ~&amp; H_1 &amp; -H_2 &amp; ~ &amp; ~ &amp; = &amp; 0\\
 \end{matrix}
\)</span></p>
<p>If we now write all the node equations then all the pipe equations we could construct the following coefficient matrix below</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The horizontal lines divide the node and the pipe equations.</p>
</div>
<p>The upper partition are the node equations in Q and H, the lower partition are the pipe equations in Q and H}</p>
<p><span class="math notranslate nohighlight">\(
\begin{matrix}
\hline
~1&amp;-1 &amp; 0  &amp; -1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp;0 \\
0&amp;~1 &amp; -1  &amp; 0 &amp; 0 &amp;~1 &amp; 0 &amp; 0 &amp; 0 &amp;0 \\
0&amp; 0 &amp; 0 &amp;~1 &amp; -1 &amp; -1 &amp; 0 &amp; 0 &amp; 0 &amp;0 \\
0&amp; 0 &amp;~1  &amp; 0 &amp;~1 &amp; 0 &amp; 0  &amp; 0 &amp; 0 &amp;0 \\
\hline
-L_1&amp; 0&amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; -1 &amp; 0 &amp; 0 &amp;0 \\
0&amp; -L_2&amp; 0 &amp; 0 &amp; 0 &amp; 0&amp;~1 &amp; -1 &amp; 0 &amp;0 \\
0&amp; 0&amp; -L_3 &amp; 0 &amp; 0 &amp; 0&amp; 0 &amp;~1 &amp; 0 &amp; -1 \\
0&amp; 0&amp; 0 &amp; -L_4 &amp; 0 &amp; 0&amp;~1 &amp; 0 &amp; -1 &amp; 0 \\
0&amp; 0&amp; 0 &amp; 0 &amp; -L_5 &amp; 0&amp; 0 &amp; 0 &amp;~1 &amp; -1 \\
0&amp; 0&amp; 0 &amp;0 &amp; 0 &amp; -L_6&amp; 0 &amp; -1 &amp;~1 &amp; 0 \\
\hline
\end{matrix}
\)</span></p>
<p>Declare the name of this matrix <span class="math notranslate nohighlight">\(\textbf{A(x)}\)</span>, where <span class="math notranslate nohighlight">\(\textbf{x}\)</span> denotes the unknown vector of Q augmented by H as above.  Next consider the right-hand-side at the correct solution (as of yet still unknown!) as</p>
<p><span class="math notranslate nohighlight">\(
\begin{matrix}
[0, &amp; 4, &amp; 3,  &amp; 1, &amp; -100 , &amp; 0, &amp; 0, &amp; 0, &amp; 0, &amp;0 ] = \textbf{b}\\
\end{matrix}
\)</span></p>
<p>So if the coefficient matrix is correct then the following system would result:
<span class="math notranslate nohighlight">\(
\mathbf{A(x)} \cdot \mathbf{x} = \mathbf{b}
\)</span></p>
<p>which would look like</p>
<div class="figure align-default" id="vm-system">
<a class="reference internal image-reference" href="../../_images/VM-system.png"><img alt="../../_images/VM-system.png" src="../../_images/VM-system.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-number">Fig. 12 </span><span class="caption-text">Pipe network illustrative example as Matrtx-Vector system of equations.</span><a class="headerlink" href="#vm-system" title="Permalink to this image">¶</a></p>
</div>
<p>Observe, the system is non-linear because the coefficient matrix depends on the current values of <span class="math notranslate nohighlight">\(Q_i\)</span> for the <span class="math notranslate nohighlight">\(L_i\)</span> terms.
However, the system is full-rank (rows == columns) so it is a candidate for Newton-Raphson.</p>
<p>Further observe that the upper partition from column 6 and smaller is simply the node-arc incidence matrix, and the lower partition for the same columns only contains <span class="math notranslate nohighlight">\(L_i\)</span> terms on its diagonal, the remainder is zero.<br />
Next observe that the partition associated with heads in the node equations is the zero-matrix.</p>
<p>Lastly (and this is important!) the lower right partition is the transpose of the node-arc incidence matrix subjected to scalar multiplication of <span class="math notranslate nohighlight">\(-1\)</span>.
The importance is that all the information needed to find a solution is contained in the node-arc incidence matrix and the right-hand-side – the engineer does not need to identify closed loops (nor does the computer need to find closed loops).</p>
<p>The trade-off is a much larger system of equations, however solving large systems is far easier that searching a directed graph to identify closed loops, furthermore we obtain the heads as part of the solution process.</p>
<div class="section" id="script-structure">
<h4>Script Structure<a class="headerlink" href="#script-structure" title="Permalink to this headline">¶</a></h4>
<p>The script will need to accomplish several tasks including reading the node-arc incidence matrix supplied as a file and convert the strings into numeric values.  The script will also need some support functions defined before constructing the matrix. First the file for the example is:</p>
<blockquote>
<div><p>PipeNetwork.txt</p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">4</span>
<span class="mi">6</span>
<span class="mf">200.0</span> <span class="mf">200.0</span> <span class="mf">200.0</span> <span class="mf">200.0</span> 
<span class="mf">1.00</span> <span class="mf">0.67</span> <span class="mf">0.67</span> <span class="mf">0.67</span> <span class="mf">0.67</span> <span class="mf">0.5</span>
<span class="mi">800</span> <span class="mi">800</span> <span class="mi">700</span> <span class="mi">700</span> <span class="mi">800</span> <span class="mi">600</span>
<span class="mf">0.00001</span> <span class="mf">0.00001</span> <span class="mf">0.00001</span> <span class="mf">0.00001</span> <span class="mf">0.00001</span> <span class="mf">0.00001</span>
<span class="mf">0.000011</span>
<span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="mi">1</span> <span class="o">-</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-</span><span class="mi">1</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span>
<span class="mi">0</span> <span class="mi">4</span> <span class="mi">3</span> <span class="mi">1</span> <span class="o">-</span><span class="mi">000</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> 

</pre></div>
</div>
<p>The rows of the input file are:</p>
<ul class="simple">
<li><p>The node count.</p></li>
<li><p>The pipe count.</p></li>
<li><p>Pipe diameters, in feet.</p></li>
<li><p>Pipe lengths, in feet.</p></li>
<li><p>Pipe roughness heights, in feet.</p></li>
<li><p>Kinematic viscosity in feet<span class="math notranslate nohighlight">\(^2\)</span>/second.</p></li>
<li><p>Initial guess of flow rates (unbalanced OK, non-zero vital!)</p></li>
<li><p>The next four rows are the node-arc incidence matrix.</p></li>
<li><p>The last row is the demand (and fixed-grade node total head) vector.</p></li>
</ul>
</div>
<div class="section" id="support-functions">
<h4>Support Functions<a class="headerlink" href="#support-functions" title="Permalink to this headline">¶</a></h4>
<p>The Reynolds number will need to be calculated for each pipe at each iteration of the solution, so a Reynolds number function will be useful.  For circular pipes, the following equation should work,</p>
<p><span class="math notranslate nohighlight">\(Re_D=\frac{V_i \cdot D_i }{\mu}\)</span></p>
<p>The Jain equation (Jain, 1976) that directly computes friction factor from Reynolds number, diameter, and roughness is</p>
<p><span class="math notranslate nohighlight">\(f= \frac{0.25}{(log_{10}(\frac{\epsilon}{3.7D}+\frac{5.74}{Re_D^{0.9}}))^2}\)</span></p>
<p>Once you have the Reynolds number for a pipe, and the friction factor, then the head loss factor that will be used in the coefficient matrix (and the Jacobian) is</p>
<p><span class="math notranslate nohighlight">\(k_i = \frac{8 \cdot L_i}{\pi^2 g  D_i^5}\)</span></p>
<p>We will also find it handy to be able to compute velocity heads  from discharge and pipe diameters so we can have a velocity function as</p>
<p><span class="math notranslate nohighlight">\(V_i = \frac{Q_i}{0.25 \cdot \pi D_i^2}\)</span></p>
<p>These support functions are coded below (in a code cell) as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># hydraulic elements prototype functions</span>
<span class="c1"># Jain Friction Factor Function -- Tested OK 23SEP16</span>
<span class="kn">import</span> <span class="nn">math</span>   <span class="c1"># This will import math module</span>

<span class="k">def</span> <span class="nf">friction_factor</span><span class="p">(</span><span class="n">roughness</span><span class="p">,</span><span class="n">diameter</span><span class="p">,</span><span class="n">reynolds</span><span class="p">):</span>
    <span class="n">temp1</span> <span class="o">=</span> <span class="n">roughness</span><span class="o">/</span><span class="p">(</span><span class="mf">3.7</span><span class="o">*</span><span class="n">diameter</span><span class="p">)</span>
    <span class="n">temp2</span> <span class="o">=</span> <span class="mf">5.74</span><span class="o">/</span><span class="p">(</span><span class="n">reynolds</span><span class="o">**</span><span class="p">(</span><span class="mf">0.9</span><span class="p">))</span>
    <span class="n">temp3</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">temp1</span><span class="o">+</span><span class="n">temp2</span><span class="p">)</span>
    <span class="n">temp3</span> <span class="o">=</span> <span class="n">temp3</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">friction_factor</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">/</span><span class="n">temp3</span>
    <span class="k">return</span><span class="p">(</span><span class="n">friction_factor</span><span class="p">)</span>

<span class="c1"># Velocity Function</span>
<span class="k">def</span> <span class="nf">velocity</span><span class="p">(</span><span class="n">diameter</span><span class="p">,</span><span class="n">discharge</span><span class="p">):</span>
    <span class="n">velocity</span><span class="o">=</span><span class="n">discharge</span><span class="o">/</span><span class="p">(</span><span class="mf">0.25</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">diameter</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>

<span class="c1"># Reynolds Number Function  </span>
<span class="k">def</span> <span class="nf">reynolds_number</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="n">diameter</span><span class="p">,</span><span class="n">mu</span><span class="p">):</span>
    <span class="n">reynolds_number</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span><span class="o">*</span><span class="n">diameter</span><span class="o">/</span><span class="n">mu</span>
    <span class="k">return</span><span class="p">(</span><span class="n">reynolds_number</span><span class="p">)</span>

<span class="c1"># Geometric factor function</span>
<span class="k">def</span> <span class="nf">k_factor</span><span class="p">(</span><span class="n">howlong</span><span class="p">,</span><span class="n">diameter</span><span class="p">,</span><span class="n">gravity</span><span class="p">):</span>
    <span class="n">k_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">howlong</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gravity</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">diameter</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">k_factor</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will need our linear solver:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># SolveLinearSystem.py</span>
<span class="c1"># Code to read A and b</span>
<span class="c1"># Then solve Ax = b for x by Gaussian elimination with back substitution</span>
<span class="c1">#</span>
<span class="c1">##########</span>
<span class="k">def</span> <span class="nf">linearsolver</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="c1">#    M = A  #this is object to object equivalence</span>
<span class="c1"># copy A into M element by element - to operate on M without destroying A</span>
    <span class="n">M</span><span class="o">=</span><span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span><span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">irow</span><span class="p">][</span><span class="n">jcol</span><span class="p">]</span><span class="o">=</span><span class="n">A</span><span class="p">[</span><span class="n">irow</span><span class="p">][</span><span class="n">jcol</span><span class="p">]</span>

<span class="c1">#</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">M</span><span class="p">:</span>
     <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
     <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
       <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]):</span>
          <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
       <span class="k">else</span><span class="p">:</span>
          <span class="k">pass</span>

     <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
         <span class="n">q</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="o">/</span> <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
         <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">-=</span>  <span class="n">q</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>

    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

    <span class="n">x</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
      <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
          <span class="n">z</span> <span class="o">=</span> <span class="n">z</span>  <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
      <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
<span class="c1">#    print (x)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1">#</span>
</pre></div>
</div>
</div>
</div>
<p>We will also find some vector-matrix manipulation functions handy</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">writeM</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">ir</span><span class="p">,</span><span class="n">jc</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;------&quot;</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="s2">&quot;------&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">jc</span><span class="p">])</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">writeV</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">ir</span><span class="p">,</span><span class="n">label</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;------&quot;</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="s2">&quot;------&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ir</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">matrixmatrixmult</span><span class="p">(</span><span class="n">amatrix</span><span class="p">,</span><span class="n">bmatrix</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">,</span><span class="n">rowNumB</span><span class="p">,</span><span class="n">colNumB</span><span class="p">):</span>
    <span class="n">AB</span> <span class="o">=</span><span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colNumB</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">colNumB</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">colNumA</span><span class="p">):</span>
                <span class="n">AB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">AB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">amatrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">bmatrix</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">AB</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">matrixvectormult</span><span class="p">(</span><span class="n">amatrix</span><span class="p">,</span><span class="n">xvector</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">):</span>
    <span class="n">bvector</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">colNumA</span><span class="p">):</span>
                <span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">amatrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">xvector</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">bvector</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">vectoradd</span><span class="p">(</span><span class="n">avector</span><span class="p">,</span><span class="n">bvector</span><span class="p">,</span><span class="n">length</span><span class="p">):</span>
    <span class="n">cvector</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">cvector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">cvector</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">vectorsub</span><span class="p">(</span><span class="n">avector</span><span class="p">,</span><span class="n">bvector</span><span class="p">,</span><span class="n">length</span><span class="p">):</span>
    <span class="n">cvector</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">cvector</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">cvector</span><span class="p">)</span>
             
<span class="k">def</span> <span class="nf">vdotv</span><span class="p">(</span><span class="n">avector</span><span class="p">,</span><span class="n">bvector</span><span class="p">,</span><span class="n">length</span><span class="p">):</span>
    <span class="n">adotb</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">adotb</span><span class="o">=</span><span class="n">adotb</span><span class="o">+</span><span class="n">avector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">bvector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">adotb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="augmented-and-jacobian-matrices">
<h4>Augmented and Jacobian Matrices<a class="headerlink" href="#augmented-and-jacobian-matrices" title="Permalink to this headline">¶</a></h4>
<p>The <span class="math notranslate nohighlight">\(\textbf{A(x)}\)</span> is built using the node-arc incidence matrix (which does not change), and the current values of <span class="math notranslate nohighlight">\(L_i\)</span>.<br />
We also need to build the Jacobian of <span class="math notranslate nohighlight">\(\textbf{A(x)}\)</span> to implement the update as-per Newton-Raphson.</p>
<p>A brief review; at the solution we can write
<span class="math notranslate nohighlight">\(\begin{equation}
[\mathbf{A}(\mathbf{x})] \cdot \mathbf{x} - \mathbf{b} = \mathbf{f}(\mathbf{x}) = \mathbf{0}
\end{equation}
\)</span></p>
<p>Lets assume we are not at the solution, so we need a way to update the current value of <span class="math notranslate nohighlight">\(\textbf{x}\)</span>.
Recall from Newton’s method (for univariate cases) that the update formula is</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
x_{k+1}=x_{k} - (\frac{df}{dx}\mid_{x_k})^{-1} f(x_k)
\end{equation}
\)</span></p>
<p>The Jacobian will play the role of the derivative, and <span class="math notranslate nohighlight">\(\textbf{x}\)</span> is now a vector (instead of a single variable).
Division is not defined for matrices, but the multiplicative inverse is (the inverse matrix), and plays the role of division.
Hence, the extension to the pipeline case is</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\mathbf{x}_{k+1}=\mathbf{x}_{k} - [\mathbf{J}(\mathbf{x}_{k})]^{-1} \mathbf{f}(\mathbf{x}_k) 
\end{equation}
\)</span></p>
<p>where <span class="math notranslate nohighlight">\(\mathbf{J}(\mathbf{x}_{k})\)</span> is the Jacobian of the coefficient matrix <span class="math notranslate nohighlight">\(\mathbf{A}\)</span> evaluated at <span class="math notranslate nohighlight">\(\mathbf{x}_{k}\)</span>.<br />
Although a bit cluttered, here is the formula for a single update step, with the matrix, demand vector, and the solution vector in their proper places.</p>
<p><span class="math notranslate nohighlight">\(
\begin{equation}
\mathbf{x}_{k+1}=\mathbf{x}_{k} - [\mathbf{J}(\mathbf{x}_{k})]^{-1} \{[\mathbf{A}(\mathbf{x}_k)] \cdot \mathbf{x}_k - \mathbf{b}\}
\end{equation}
\)</span></p>
<p>As a practical matter we actually never invert the Jacobian, instead we solve the related Linear system of</p>
<p><span class="math notranslate nohighlight">\(
[\mathbf{J}(\mathbf{x}_{k})] \cdot \Delta \mathbf{x} = \{[\mathbf{A}(\mathbf{x}_k)] \cdot \mathbf{x}_k - \mathbf{b}\}
\)</span></p>
<p>for <span class="math notranslate nohighlight">\(\Delta\textbf{x}\)</span>, then perform the update as <span class="math notranslate nohighlight">\(\textbf{x}_{k+1} = \textbf{x}_{k} - \Delta\textbf{x}\)</span></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Inverting the matrix every step is computationally inefficient, and unnecessary.  As an example, solving the system in this case would at worst take 10 row operations each step, but nearly 100 row operations to invert at each step – to accomplish the same result, generate an update.  Now imagine when there are hundreds of nodes and pipes!</p>
</div>
<p>The Jacobian of the pipeline model is a matrix with the following properties:</p>
<ul class="simple">
<li><p>The partition of the matrix that corresponds to the node formulas (upper left partition) is identical to the original coefficient matrix — it will be comprised of <span class="math notranslate nohighlight">\(0~\text{or}~\pm~1\)</span> in the same pattern at the equivalent partition of the <span class="math notranslate nohighlight">\(\mathbf{A}\)</span> matrix.</p></li>
<li><p>The partition of the matrix that corresponds to the pipe head loss terms (lower left partition), will consist of values that are twice the values of the coefficients in the original coefficient matrix (at any supplied value of <span class="math notranslate nohighlight">\(\mathbf{x}_k\)</span>.</p></li>
<li><p>The partition of the matrix that corresponds to the head terms (lower right partition), will consist of values that are identical to the original matrix.</p></li>
<li><p>The partition of the matrix that corresponds to the head coefficients in the node equations (upper right partition) will also remain unchanged.</p></li>
</ul>
<p>We will want to take advantage of problem structure to build the Jacobian (you could just finite-difference the coefficient matrix to approximate the partial derivatives, but that is terribly inefficient if you already know the structure).</p>
<p>So now lets code reading the input file and building at least the starting instance of the matrix equations</p>
<p>First allocate some memory</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bvector</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">rowNumA</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">colNumA</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">rowNumB</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span> <span class="c1"># set to true for in-class demonstration</span>
<span class="c1">#############################################</span>

<span class="n">elevation</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># null list node elevations</span>
<span class="n">diameter</span> <span class="o">=</span>  <span class="p">[]</span> <span class="c1"># null list pipe diameters</span>
<span class="n">distance</span> <span class="o">=</span>  <span class="p">[]</span> <span class="c1"># null list pipe lengths</span>
<span class="n">roughness</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># null list pipe roughness</span>
<span class="n">flowguess</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># null list pipe flow rates</span>
<span class="n">nodearcs</span> <span class="o">=</span>  <span class="p">[]</span> <span class="c1"># node-arc incidence matrix</span>
<span class="n">rhs_true</span> <span class="o">=</span>  <span class="p">[]</span> <span class="c1"># null list for nodal demands</span>
<span class="n">tempvect</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<p>Now read in the data from a file (useful to expand problem scale to many,many pipes and nodes).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">##############################################</span>
<span class="c1"># connect and read file for Pipeline Network #</span>
<span class="c1">##############################################</span>
<span class="n">afile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;PipeNetwork.txt&quot;</span><span class="p">,</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">nnodes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<span class="n">npipes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<span class="c1"># read elevation vector</span>
<span class="n">tempvect</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">elevation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tempvect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
<span class="n">tempvect</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># reset vector</span>
<span class="c1"># read diameter vector</span>
<span class="n">tempvect</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">diameter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tempvect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
<span class="n">tempvect</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># reset vector</span>
<span class="c1"># read length vector</span>
<span class="n">tempvect</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">distance</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tempvect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
<span class="n">tempvect</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># reset vector</span>
<span class="c1"># read roughness vector</span>
<span class="n">tempvect</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">roughness</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tempvect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
<span class="n">tempvect</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># reset vector</span>
<span class="c1"># read viscosity (scalar)</span>
<span class="n">viscosity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
<span class="c1"># read current flow guess</span>
<span class="n">tempvect</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">flowguess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tempvect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
<span class="n">tempvect</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># reset vector</span>
<span class="c1"># read nodearc incidence matrix</span>
<span class="c1">## future revisions read directly into augmented matrix, or find way to release nodearc from stack</span>
<span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># then read each row</span>
    <span class="n">nodearcs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
<span class="c1"># read demands guess</span>
<span class="n">tempvect</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">afile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">rhs_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tempvect</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
<span class="n">tempvect</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># reset vector      </span>
<span class="c1">######################################</span>
<span class="c1"># end file read ,disconnect file     #</span>
<span class="c1">######################################</span>
<span class="n">afile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Disconnect the file</span>
</pre></div>
</div>
</div>
</div>
<p>Echo the data just read, could put into a conditional and choose not to display except for debugging.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">######################################</span>
<span class="c1"># echo the input in human readable   #</span>
<span class="c1">######################################</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of nodes : &#39;</span><span class="p">,</span><span class="n">nnodes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of pipes : &#39;</span><span class="p">,</span><span class="n">npipes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;viscosity       : &#39;</span><span class="p">,</span><span class="n">viscosity</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;node id:&#39;</span><span class="p">,</span><span class="n">irow</span><span class="p">,</span> <span class="s1">&#39;, elevation :&#39;</span><span class="p">,</span><span class="n">elevation</span><span class="p">[</span><span class="n">irow</span><span class="p">],</span><span class="s1">&#39; head :&#39;</span><span class="p">,</span><span class="n">rhs_true</span><span class="p">[</span><span class="n">irow</span><span class="o">+</span><span class="n">npipes</span><span class="p">])</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pipe id:&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39;, diameter : &#39;</span> <span class="p">,</span><span class="n">diameter</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s1">&#39;, distance : &#39;</span><span class="p">,</span><span class="n">distance</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span>
          <span class="s1">&#39;, roughness : &#39;</span><span class="p">,</span><span class="n">roughness</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s1">&#39;, flow  : &#39;</span><span class="p">,</span><span class="n">flowguess</span><span class="p">[</span><span class="n">jcol</span><span class="p">])</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
<span class="c1">##for jcol in range(0,nnodes+npipes):</span>
<span class="c1">##    print(&#39;irow :&#39;,jcol,&#39; RHS True :&#39;,rhs_true[jcol])</span>
<span class="c1">##print (&quot;-----------------------------&quot;)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;node-arc incidence matrix&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="n">nodearcs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">npipes</span><span class="p">])</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>number of nodes :  4
number of pipes :  6
viscosity       :  1.1e-05
-----------------------------
node id: 0 , elevation : 0.0  head : 0.0
node id: 1 , elevation : 0.0  head : 0.0
node id: 2 , elevation : 0.0  head : 0.0
node id: 3 , elevation : 0.0  head : 0.0
-----------------------------
pipe id: 0 , diameter :  1.0 , distance :  800.0 , roughness :  1e-05 , flow  :  1.0
pipe id: 1 , diameter :  0.67 , distance :  800.0 , roughness :  1e-05 , flow  :  1.0
pipe id: 2 , diameter :  0.67 , distance :  700.0 , roughness :  1e-05 , flow  :  1.0
pipe id: 3 , diameter :  0.67 , distance :  700.0 , roughness :  1e-05 , flow  :  1.0
pipe id: 4 , diameter :  0.67 , distance :  800.0 , roughness :  1e-05 , flow  :  1.0
pipe id: 5 , diameter :  0.5 , distance :  600.0 , roughness :  1e-05 , flow  :  1.0
-----------------------------
node-arc incidence matrix
[1.0, -1.0, 0.0, -1.0, 0.0, 0.0]
[0.0, 1.0, -1.0, 0.0, 0.0, 1.0]
[0.0, 0.0, 0.0, 1.0, -1.0, -1.0]
[0.0, 0.0, 1.0, 0.0, 1.0, 0.0]
-----------------------------
</pre></div>
</div>
</div>
</div>
<p>Now create the augmented matrix using the structure of the problem.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create augmented matrix</span>
<span class="n">colNumA</span> <span class="o">=</span> <span class="n">npipes</span><span class="o">+</span><span class="n">nnodes</span>
<span class="n">rowNumA</span> <span class="o">=</span> <span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span>
<span class="n">augmentedMat</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># null list to store augmented matrix</span>

<span class="c1">#######################################################################################</span>
<span class="n">augmentedMat</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colNumA</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span> <span class="c1">#fill with zeroes</span>
<span class="c1">#build upper left partition -- from nodearcs</span>
<span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">jc</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">):</span>
        <span class="n">augmentedMat</span><span class="p">[</span><span class="n">ir</span><span class="p">][</span><span class="n">jc</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodearcs</span><span class="p">[</span><span class="n">ir</span><span class="p">][</span><span class="n">jc</span><span class="p">]</span>
<span class="n">istart</span><span class="o">=</span><span class="n">nnodes</span>
<span class="n">iend</span><span class="o">=</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span>
<span class="n">jstart</span><span class="o">=</span><span class="n">npipes</span>
<span class="n">jend</span><span class="o">=</span><span class="n">npipes</span><span class="o">+</span><span class="n">nnodes</span>
<span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">istart</span><span class="p">,</span><span class="n">iend</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">jc</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">jstart</span><span class="p">,</span><span class="n">jend</span><span class="p">):</span>
        <span class="n">augmentedMat</span><span class="p">[</span><span class="n">ir</span><span class="p">][</span><span class="n">jc</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">nodearcs</span><span class="p">[</span><span class="n">jc</span><span class="o">-</span><span class="n">jstart</span><span class="p">][</span><span class="n">ir</span><span class="o">-</span><span class="n">istart</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.0</span>
<span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;augmented matrix before loss factors&quot;</span><span class="p">)</span>
    <span class="n">writeM</span><span class="p">(</span><span class="n">augmentedMat</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">,</span><span class="s2">&quot;augmented matrix&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="stopping-criteria-and-solution-report">
<h4>Stopping Criteria, and Solution Report}<a class="headerlink" href="#stopping-criteria-and-solution-report" title="Permalink to this headline">¶</a></h4>
<p>You will need some way to stop the process – the three most obvious (borrowed from Newton’s method) are:</p>
<ul class="simple">
<li><p>Approaching the correct solution (e.g. <span class="math notranslate nohighlight">\([\mathbf{A}(\mathbf{x})] \cdot \mathbf{x} - \mathbf{b} = \mathbf{f}(\mathbf{x}) = \mathbf{0}\)</span>).</p></li>
<li><p>Update vector is not changing (e.g. <span class="math notranslate nohighlight">\(\mathbf{x}_{k+1}=\mathbf{x}_{k}\)</span>), so either have an answer, or the algorithm is stuck.</p></li>
<li><p>You have done a lot of iterations (say 100).</p></li>
</ul>
<p>We want to have the script determine when to stop and report the conditions (which stopping criterion was used), and the values of flows and heads in the system.</p>
<p>Fisrt lets set some tolerances and an iteration limit, as well as allocate memory to store the auxiliary functions results</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#######################################################################################</span>
<span class="n">howmany</span><span class="o">=</span><span class="mi">50</span> <span class="c1">#iterations max</span>
<span class="n">tolerance1</span> <span class="o">=</span> <span class="mf">1e-24</span>
<span class="n">tolerance2</span> <span class="o">=</span> <span class="mf">1e-24</span>
<span class="n">velocity_pipe</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npipes</span><span class="p">)]</span>  <span class="c1"># null list velocities</span>
<span class="n">reynolds</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npipes</span><span class="p">)]</span>  <span class="c1"># null list reynolds numbers</span>
<span class="n">friction</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npipes</span><span class="p">)]</span>  <span class="c1"># null list friction </span>
<span class="n">geometry</span>      <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npipes</span><span class="p">)]</span>  <span class="c1"># null list geometry</span>
<span class="n">lossfactor</span>    <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npipes</span><span class="p">)]</span>  <span class="c1"># null list loss</span>
<span class="n">jacbMat</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># null list to store jacobian matrix</span>
<span class="n">jacbMat</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colNumA</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span> <span class="c1">#fill with zeroes</span>


<span class="n">solvecguess</span> <span class="o">=</span><span class="p">[</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span> 
<span class="n">solvecnew</span> <span class="o">=</span><span class="p">[</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">solvecguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">flowguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_factor</span><span class="p">(</span><span class="n">distance</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">diameter</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mf">32.2</span><span class="p">)</span>
<span class="c1">#solvecguess is a current guess -- wonder if more pythonic way for this assignment</span>
<span class="c1">##    print(&#39;irow :&#39;,i,&#39; Geometry Factor :&#39;,geometry[i])</span>
<span class="c1">##print (&quot;-----------------------------&quot;)</span>
</pre></div>
</div>
</div>
</div>
<p>And finally the money shot; where we wrap everything into a for loop to iteratively find a solution</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">###############################################################</span>
<span class="c1">## ITERATION LOOP                                             #</span>
<span class="c1">###############################################################</span>
<span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">howmany</span><span class="p">):</span> <span class="c1"># iteration outer loop</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solutions at begin of iteration&quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;irow :&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39; solvecnew :&#39;</span><span class="p">,</span><span class="n">solvecnew</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s2">&quot; solvecguess &quot;</span><span class="p">,</span><span class="n">solvecguess</span><span class="p">[</span><span class="n">jcol</span><span class="p">])</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">velocity_pipe</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">velocity</span><span class="p">(</span><span class="n">diameter</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">flowguess</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>    
        <span class="n">reynolds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">reynolds_number</span><span class="p">(</span><span class="n">velocity_pipe</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">diameter</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">viscosity</span><span class="p">)</span>
        <span class="n">friction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">friction_factor</span><span class="p">(</span><span class="n">roughness</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">diameter</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">reynolds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">lossfactor</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">friction</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">geometry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">flowguess</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pipe id:&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39;, velocity : &#39;</span> <span class="p">,</span><span class="n">velocity_pipe</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s1">&#39;, reynolds : &#39;</span><span class="p">,</span><span class="n">reynolds</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span>
          <span class="s1">&#39;, friction : &#39;</span><span class="p">,</span><span class="n">friction</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s1">&#39;, loss factor : &#39;</span><span class="p">,</span><span class="n">lossfactor</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s1">&#39;flow guess&#39;</span><span class="p">,</span><span class="n">flowguess</span><span class="p">[</span><span class="n">jcol</span><span class="p">])</span>
<span class="c1">################################################################</span>
<span class="c1"># BUILD AUGMENTED MATRIX CURRENT Q+H SOLUTION                  #</span>
<span class="c1">################################################################</span>
    <span class="n">augmentedMat</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colNumA</span><span class="p">)]</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span> <span class="c1">#fill with zeroes</span>
    <span class="c1">#build upper left partition -- from nodearcs</span>
    <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jc</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">):</span>
            <span class="n">augmentedMat</span><span class="p">[</span><span class="n">ir</span><span class="p">][</span><span class="n">jc</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodearcs</span><span class="p">[</span><span class="n">ir</span><span class="p">][</span><span class="n">jc</span><span class="p">]</span>
    <span class="c1">#build lower right == transpose of upper left</span>
    <span class="n">istart</span><span class="o">=</span><span class="n">nnodes</span>
    <span class="n">iend</span><span class="o">=</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span>
    <span class="n">jstart</span><span class="o">=</span><span class="n">npipes</span>
    <span class="n">jend</span><span class="o">=</span><span class="n">npipes</span><span class="o">+</span><span class="n">nnodes</span>
    <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">istart</span><span class="p">,</span><span class="n">iend</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">jc</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">jstart</span><span class="p">,</span><span class="n">jend</span><span class="p">):</span>
            <span class="n">augmentedMat</span><span class="p">[</span><span class="n">ir</span><span class="p">][</span><span class="n">jc</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">nodearcs</span><span class="p">[</span><span class="n">jc</span><span class="o">-</span><span class="n">jstart</span><span class="p">][</span><span class="n">ir</span><span class="o">-</span><span class="n">istart</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.0</span>
    <span class="c1"># build lower left partition of the matrix</span>
    <span class="n">istart</span> <span class="o">=</span> <span class="n">nnodes</span>
    <span class="n">iend</span> <span class="o">=</span> <span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span>
    <span class="n">jstart</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">jend</span> <span class="o">=</span> <span class="n">npipes</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">istart</span><span class="p">,</span><span class="n">iend</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jstart</span><span class="p">,</span><span class="n">jend</span> <span class="p">):</span>
    <span class="c1">#        print(&#39;i =&#39;,i,&#39;j=&#39;,j)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">istart</span><span class="p">)</span> <span class="o">==</span> <span class="n">j</span> <span class="p">:</span>
    <span class="c1">#            print(&#39;i =&#39;,i,&#39;j=&#39;,j)</span>
                <span class="n">augmentedMat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">lossfactor</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;updated augmented matrix in iteration&quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">writeM</span><span class="p">(</span><span class="n">augmentedMat</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">,</span><span class="s2">&quot;augmented matrix&quot;</span><span class="p">)</span>
<span class="c1">################################################################</span>
<span class="c1"># BUILD JACOBIAN MATRIX CURRENT Q+H SOLUTION                   #</span>
<span class="c1">################################################################        </span>
    <span class="c1"># now build current jacobian</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colNumA</span><span class="p">):</span>
            <span class="n">jacbMat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">augmentedMat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="c1"># modify lower left partition</span>
    <span class="n">istart</span> <span class="o">=</span> <span class="n">nnodes</span>
    <span class="n">iend</span> <span class="o">=</span> <span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span>
    <span class="n">jstart</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">jend</span> <span class="o">=</span> <span class="n">npipes</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">istart</span><span class="p">,</span><span class="n">iend</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jstart</span><span class="p">,</span><span class="n">jend</span> <span class="p">):</span>
    <span class="c1">#        print(&#39;i =&#39;,i,&#39;j=&#39;,j)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">istart</span><span class="p">)</span> <span class="o">==</span> <span class="n">j</span> <span class="p">:</span>
    <span class="c1">#            print(&#39;i =&#39;,i,&#39;j=&#39;,j)</span>
                <span class="n">jacbMat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">jacbMat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
<span class="c1">##        for jcol in range(0,nnodes+npipes):</span>
<span class="c1">##            print(&#39;irow :&#39;,jcol,&#39; solvecnew :&#39;,solvecnew[jcol],&quot; solvecguess &quot;,solvecguess[jcol])</span>
<span class="c1">##        print (&quot;-----------------------------&quot;)</span>
<span class="c1"># matrix multiply augmentedMat*solvecguess to get current g(Q)</span>
<span class="c1">#    gq = [0.0 for i in range(rowNumA)] # zero gradient vector</span>
<span class="c1">##    if verbose == &#39;true&#39; :</span>
<span class="c1">##        print(&quot;augmented matrix in iteration&quot;,iteration)</span>
<span class="c1">##        writeM(augmentedMat,rowNumA,colNumA,&quot;augmented matrix before mmult&quot;)</span>
    <span class="n">gq</span> <span class="o">=</span> <span class="n">matrixvectormult</span><span class="p">(</span><span class="n">augmentedMat</span><span class="p">,</span><span class="n">solvecguess</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">)</span>
<span class="c1">##    if verbose == &#39;true&#39; :</span>
<span class="c1">##        writeV(gq,rowNumA,&quot;gq vectorbefore subtract rhs_true&quot;)</span>
<span class="c1"># subtract rhs</span>
<span class="c1">#    for i in range(rowNumA):</span>
    <span class="n">gq</span> <span class="o">=</span> <span class="n">vectorsub</span><span class="p">(</span><span class="n">gq</span><span class="p">,</span><span class="n">rhs_true</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">)</span><span class="c1">#vector subtract</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;computed g(q) in iteration&quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">writeV</span><span class="p">(</span><span class="n">gq</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="s2">&quot;gq vector&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;compare current and new guess&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;irow :&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39; solvecnew :&#39;</span><span class="p">,</span><span class="n">solvecnew</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s2">&quot; solvecguess &quot;</span><span class="p">,</span><span class="n">solvecguess</span><span class="p">[</span><span class="n">jcol</span><span class="p">])</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
    <span class="n">dq</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span> <span class="c1"># zero update vector</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="n">writeV</span><span class="p">(</span><span class="n">dq</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="s2">&quot;dq vector before linear solve&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jacobian before linearsolve in iteration&quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">writeM</span><span class="p">(</span><span class="n">jacbMat</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">,</span><span class="s2">&quot;jabobian matrix&quot;</span><span class="p">)</span>
    <span class="n">dq</span> <span class="o">=</span> <span class="n">linearsolver</span><span class="p">(</span><span class="n">jacbMat</span><span class="p">,</span><span class="n">gq</span><span class="p">)</span> <span class="c1"># memory leak after this call - linearsolve clobbers input lists</span>
<span class="c1">#    dq = np.linalg.solve(jacbMat,gq)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jacobian after linearsolve in iteration&quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
        <span class="n">writeM</span><span class="p">(</span><span class="n">jacbMat</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">,</span><span class="s2">&quot;jabobian matrix&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="n">writeV</span><span class="p">(</span><span class="n">dq</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="s2">&quot;dq vector -after linear solve&quot;</span><span class="p">)</span>
    <span class="n">solvecnew</span> <span class="o">=</span> <span class="n">vectorsub</span><span class="p">(</span><span class="n">solvecguess</span><span class="p">,</span><span class="n">dq</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">)</span><span class="c1">#vector subtract</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Q_new = Q_old - DQ&quot;</span><span class="p">)</span>
        <span class="n">writeV</span><span class="p">(</span><span class="n">solvecnew</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="s2">&quot;new guess vector&quot;</span><span class="p">)</span>
<span class="c1">#    tempvect =[ 0.0 for i in range(rowNumA)]</span>
<span class="c1">##        tempvect = matrixvectormult(jacbMat,dq,rowNumA,colNumA)</span>
<span class="c1">##        writeV(tempvect,rowNumA,&quot;J*dq vector&quot;)</span>
<span class="c1">##        tempvect = vectorsub(tempvect,gq,rowNumA)</span>
<span class="c1">##        writeV(tempvect,rowNumA,&quot;J*dq - gq vector&quot;)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;just after computing new guess, should be different&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;irow :&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39; solvecnew :&#39;</span><span class="p">,</span><span class="n">solvecnew</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s2">&quot; solvecguess &quot;</span><span class="p">,</span><span class="n">solvecguess</span><span class="p">[</span><span class="n">jcol</span><span class="p">])</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
<span class="c1">#test for stopping</span>
    <span class="n">tempvect</span> <span class="o">=</span><span class="p">[</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">):</span>
        <span class="n">tempvect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">solvecnew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">solvecguess</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">test1</span> <span class="o">=</span> <span class="n">vdotv</span><span class="p">(</span><span class="n">tempvect</span><span class="p">,</span><span class="n">tempvect</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="n">test1</span><span class="p">)</span>
    <span class="n">tempvect</span> <span class="o">=</span><span class="p">[</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rowNumA</span><span class="p">):</span>
        <span class="n">tempvect</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">gq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">test2</span> <span class="o">=</span> <span class="n">vdotv</span><span class="p">(</span><span class="n">tempvect</span><span class="p">,</span><span class="n">tempvect</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;test2&#39;</span><span class="p">,</span><span class="n">test2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test1</span> <span class="o">&lt;</span> <span class="n">tolerance1</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;update not changing --exit and report current update&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
<span class="c1"># update guess</span>
        <span class="n">solvecguess</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">solvecnew</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">flowguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">solvecguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">break</span>
    <span class="k">if</span> <span class="n">test2</span> <span class="o">&lt;</span> <span class="n">tolerance2</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gradient near zero --exit and report current update&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
<span class="c1"># update guess</span>
        <span class="n">solvecguess</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">solvecnew</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">flowguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">solvecguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">break</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solution continuing&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iteration&quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
    <span class="c1"># update guess</span>
    <span class="n">solvecguess</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">solvecnew</span><span class="p">[:]</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">flowguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">solvecguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="c1">## Write Current State ######################</span>
        <span class="n">gq</span> <span class="o">=</span> <span class="n">matrixvectormult</span><span class="p">(</span><span class="n">augmentedMat</span><span class="p">,</span><span class="n">solvecguess</span><span class="p">,</span><span class="n">rowNumA</span><span class="p">,</span><span class="n">colNumA</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of nodes : &#39;</span><span class="p">,</span><span class="n">nnodes</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of pipes : &#39;</span><span class="p">,</span><span class="n">npipes</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;viscosity       : &#39;</span><span class="p">,</span><span class="n">viscosity</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;node id:&#39;</span><span class="p">,</span><span class="n">irow</span><span class="p">,</span> <span class="s1">&#39;, elevation :&#39;</span><span class="p">,</span><span class="n">elevation</span><span class="p">[</span><span class="n">irow</span><span class="p">])</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pipe id:&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39;, diameter : &#39;</span> <span class="p">,</span><span class="n">diameter</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s1">&#39;, distance : &#39;</span><span class="p">,</span><span class="n">distance</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span>
          <span class="s1">&#39;, roughness : &#39;</span><span class="p">,</span><span class="n">roughness</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s1">&#39;, flow guess : &#39;</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">flowguess</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;irow :&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39; RHS True :&#39;</span><span class="p">,</span><span class="n">rhs_true</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s2">&quot;RHS Current&quot;</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">gq</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;irow :&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39; solvecnew :&#39;</span><span class="p">,</span><span class="n">solvecnew</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s2">&quot; solvecguess &quot;</span><span class="p">,</span><span class="n">solvecguess</span><span class="p">[</span><span class="n">jcol</span><span class="p">])</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>   
<span class="c1">################################################</span>
<span class="c1"># end of outer loop</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>update not changing --exit and report current update
iteration 39
</pre></div>
</div>
</div>
</div>
<p>Finally write the results and exit the process</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;results at iteration = :&quot;</span><span class="p">,</span><span class="n">iteration</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">flowguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">solvecguess</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of nodes : &#39;</span><span class="p">,</span><span class="n">nnodes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of pipes : &#39;</span><span class="p">,</span><span class="n">npipes</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;viscosity       : &#39;</span><span class="p">,</span><span class="n">viscosity</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
<span class="n">istart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npipes</span><span class="p">)</span>
<span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;node id:&#39;</span><span class="p">,</span><span class="n">irow</span><span class="p">,</span> <span class="s1">&#39;, elevation :&#39;</span><span class="p">,</span><span class="n">elevation</span><span class="p">[</span><span class="n">irow</span><span class="p">],</span><span class="s1">&#39; head :&#39;</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">solvecnew</span><span class="p">[</span><span class="n">irow</span><span class="o">+</span><span class="n">npipes</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">npipes</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pipe id:&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39;, diameter : &#39;</span> <span class="p">,</span><span class="n">diameter</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s1">&#39;, distance : &#39;</span><span class="p">,</span><span class="n">distance</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span>
  <span class="s1">&#39;, roughness : &#39;</span><span class="p">,</span><span class="n">roughness</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s1">&#39;, flow  : &#39;</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">flowguess</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="p">:</span>
    <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;irow :&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39; RHS True :&#39;</span><span class="p">,</span><span class="n">rhs_true</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s2">&quot;RHS Current&quot;</span><span class="p">,</span><span class="n">gq</span><span class="p">[</span><span class="n">jcol</span><span class="p">])</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">jcol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nnodes</span><span class="o">+</span><span class="n">npipes</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;irow :&#39;</span><span class="p">,</span><span class="n">jcol</span><span class="p">,</span><span class="s1">&#39; solvecnew :&#39;</span><span class="p">,</span><span class="n">solvecnew</span><span class="p">[</span><span class="n">jcol</span><span class="p">],</span><span class="s2">&quot; solvecguess &quot;</span><span class="p">,</span><span class="n">solvecguess</span><span class="p">[</span><span class="n">jcol</span><span class="p">])</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>results at iteration = : 39
number of nodes :  4
number of pipes :  6
viscosity       :  1.1e-05
-----------------------------
node id: 0 , elevation : 0.0  head : 97.197
node id: 1 , elevation : 0.0  head : 87.489
node id: 2 , elevation : 0.0  head : 88.871
node id: 3 , elevation : 0.0  head : 87.013
-----------------------------
pipe id: 0 , diameter :  1.0 , distance :  800.0 , roughness :  1e-05 , flow  :  8.0
pipe id: 1 , diameter :  0.67 , distance :  800.0 , roughness :  1e-05 , flow  :  4.04
pipe id: 2 , diameter :  0.67 , distance :  700.0 , roughness :  1e-05 , flow  :  0.227
pipe id: 3 , diameter :  0.67 , distance :  700.0 , roughness :  1e-05 , flow  :  3.96
pipe id: 4 , diameter :  0.67 , distance :  800.0 , roughness :  1e-05 , flow  :  0.773
pipe id: 5 , diameter :  0.5 , distance :  600.0 , roughness :  1e-05 , flow  :  0.187
-----------------------------
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="exercise-1">
<h3>Exercise 1:<a class="headerlink" href="#exercise-1" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="#simplenetwork"><span class="std std-numref">Fig. 13</span></a> is a five-pipe network with a water supply source at Node 1, and demands at Nodes 1-4.  The pipe dimensions are shown in  the figure.</p>
<div class="figure align-default" id="simplenetwork">
<a class="reference internal image-reference" href="../../_images/SimpleNetwork.png"><img alt="../../_images/SimpleNetwork.png" src="../../_images/SimpleNetwork.png" style="width: 400px;" /></a>
<p class="caption"><span class="caption-number">Fig. 13 </span><span class="caption-text">Pipe network for</span><a class="headerlink" href="#simplenetwork" title="Permalink to this image">¶</a></p>
</div>
<ol class="simple">
<li><p>Make a table that lists each node name, node elevation, and the resultant pressure in U.S. Customary units.</p></li>
<li><p>Make a table that lists each pipe name,  length,  diameter,  roughness height, and the resultant flow rate in U.S. Customary units.</p></li>
<li><p>Determine the flow rate in each pipe of the network, for the case where the total head at Node 1 is 100 feet.</p></li>
<li><p>Determine the Darcy-Weisbach friction factor in each pipe of the network.</p></li>
<li><p>Using the results of your flow distribution, determine the head loss from Node 1 to Node 4.</p></li>
<li><p>Determine the head at Node 4</p></li>
<li><p>Identify the node with the lowest <strong>pressure</strong> in your solution.</p></li>
</ol>
</div>
<div class="section" id="exercise-2-advanced-optional">
<h3>Exercise 2 (Advanced; optional)<a class="headerlink" href="#exercise-2-advanced-optional" title="Permalink to this headline">¶</a></h3>
<p>Modify the algorithm and script to replace Pipe 1 in the lesson example <a class="reference internal" href="#pipe-net-hybrid"><span class="std std-numref">Fig. 11</span></a> with a pump with the following pump curve.</p>
<p><span class="math notranslate nohighlight">\(\begin{equation}
h_p = H_{\text{shutoff}} - K_{pump}Q^2
\end{equation}
\)</span></p>
<p>Starting with values of shutoff head (116’) and a pump constant (0.05) and exponent (2) to supply water to the nodes; assume the supply node is as shown and all the nodes are at elevation 100’ (thus the pump must lift 100’).</p>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./lessons/lesson10"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="../lesson09/lesson09.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">9: Matrix Manipulation(s) using <em>NumPy</em></p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="../lesson11/lesson11.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">11: Databases</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Theodore G. Cleveland and Farhang Forghanparast<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>